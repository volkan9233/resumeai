<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ResumeAI — Create Resume</title>
  <style>
    body{margin:0;font-family:Inter,system-ui,Arial;background:#0b0f19;color:#e5e7eb}
    .wrap{max-width:980px;margin:auto;padding:40px 20px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{font-size:13px;color:#9ca3af}
    input,textarea,select{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:#111827;color:#e5e7eb;outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:14px}
    button{
      padding:12px 16px;border:0;border-radius:12px;
      background:linear-gradient(135deg,#7b5cff,#5b3dff);
      color:#fff;font-weight:800;cursor:pointer;
    }
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#9ca3af;font-size:13px}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    a.back{color:#a5b4fc;text-decoration:none}
    .err{color:#fecaca}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="/index.html">← <span id="t_back">Back</span></a>
      <div class="muted" id="t_badge">ResumeAI · Create</div>
    </div>

    <h1 style="margin:10px 0 4px 0;" id="t_title">Create your resume</h1>
    <div class="muted" id="t_sub">Fill your details → ResumeAI writes strong bullets → export ATS/Modern PDF.</div>

    <div class="card" style="margin-top:16px">
      <div class="grid">
        <div>
          <label id="l_lang">Language</label>
          <select id="lang">
            <option value="en">English</option>
            <option value="tr">Türkçe</option>
            <option value="es">Español</option>
            <option value="ru">Русский</option>
            <option value="fr">Français</option>
            <option value="ar">العربية</option>
            <option value="zh">中文</option>
          </select>
        </div>

        <div>
          <label id="l_jd">Optional: Job description (for tailoring)</label>
          <input id="jd" />
        </div>

        <div>
          <label id="l_fullName">Full name</label>
          <input id="fullName" />
        </div>

        <div>
          <label id="l_title">Title</label>
          <input id="title" />
        </div>

        <div>
          <label id="l_location">Location</label>
          <input id="location" />
        </div>

        <div>
          <label id="l_email">Email</label>
          <input id="email" />
        </div>

        <div>
          <label id="l_phone">Phone</label>
          <input id="phone" />
        </div>

        <div>
          <label id="l_links">Links (one per line: Label | URL)</label>
          <input id="links" />
        </div>

        <div>
          <label id="l_skills">Skills (comma separated)</label>
          <input id="skills" />
        </div>

        <div>
          <label id="l_langs">Languages (one per line: Name | Level)</label>
          <input id="langs" />
        </div>
      </div>

      <!-- EXPERIENCE -->
      <div style="margin-top:14px">
        <label id="l_experience">Experience (one role per block)</label>
        <textarea id="experience"></textarea>
        <div class="muted" style="margin-top:6px" id="t_exp_help">
          Tip: You can use either “Role/Company/Start/End/Location/Notes” format OR simple lines.
        </div>
      </div>

      <!-- EDUCATION -->
      <div style="margin-top:14px">
        <label id="l_education">Education (one item per block)</label>
        <textarea id="education"></textarea>
        <div class="muted" style="margin-top:6px" id="t_edu_help">Optional. Leave empty if you don’t have it.</div>
      </div>

      <!-- PROJECTS -->
      <div style="margin-top:14px">
        <label id="l_projects">Projects (one project per block)</label>
        <textarea id="projects"></textarea>
        <div class="muted" style="margin-top:6px" id="t_proj_help">Tech = comma separated. Notes = what you did; ResumeAI turns it into bullets.</div>
      </div>

      <div class="row">
        <button id="btn">Generate CV + PDF</button>
        <div id="status" class="muted"></div>
      </div>
    </div>
  </div>

<script>
/** ---------------- i18n (UI only) ---------------- */
const I18N = {
  en: {
    back:"Back", badge:"ResumeAI · Create",
    title:"Create your resume",
    sub:"Fill your details → ResumeAI writes strong bullets → export ATS/Modern PDF.",
    l_lang:"Language",
    l_jd:"Optional: Job description (for tailoring)",
    ph_jd:"Paste job description (optional)",
    l_fullName:"Full name", ph_fullName:"John Doe",
    l_title:"Title", ph_title:"Marketing Manager / Frontend Developer",
    l_location:"Location", ph_location:"Istanbul, TR",
    l_email:"Email", ph_email:"you@email.com",
    l_phone:"Phone", ph_phone:"+90 ...",
    l_links:"Links (one per line: Label | URL)", ph_links:"LinkedIn | https://linkedin.com/in/...",
    l_skills:"Skills (comma separated)", ph_skills:"GA4, SEO, SQL, React, ...",
    l_langs:"Languages (one per line: Name | Level)", ph_langs:"English | Native\nTurkish | Native",
    l_experience:"Experience (one role per block)",
    ph_experience:
`Option A (structured):
Role: Marketing Manager
Company: ABC
Start: 2022
End: Present
Location: Remote
Notes: ran paid search, improved landing pages

Option B (simple lines):
Marketing Manager
ABC
2022 - Present
Remote
ran paid search, improved landing pages`,
    exp_help:"Tip: You can use either “Role/Company/Start/End/Location/Notes” format OR simple lines.",
    l_education:"Education (one item per block)",
    ph_education:
`Option A (structured):
School: University of X
Degree: BSc Computer Engineering
Start: 2016
End: 2020
Notes: GPA, honors, coursework (optional)

Option B (simple lines):
University of X
BSc Computer Engineering
2016 - 2020
GPA 3.4 (optional)`,
    edu_help:"Optional. Leave empty if you don’t have it.",
    l_projects:"Projects (one project per block)",
    ph_projects:
`Option A (structured):
Name: ResumeAI.work
Tech: Next.js, OpenAI API, Upstash
Notes: built ATS analyzer + PDF exports

Option B (simple lines):
ResumeAI.work
Next.js, OpenAI API, Upstash
built ATS analyzer + PDF exports`,
    proj_help:"Tech = comma separated. Notes = what you did; ResumeAI turns it into bullets.",
    btn:"Generate CV + PDF",
    gen:"Generating…",
    done:"Done ✅ Opening PDF…",
    errPrefix:"Error: ",
    missingBasics:"Please fill at least Full name + Title (position)."
  },
  tr: {
    back:"Geri", badge:"ResumeAI · CV Oluştur",
    title:"CV oluştur",
    sub:"Bilgilerini gir → ResumeAI güçlü bullet’lar yazar → ATS/Modern PDF çıkar.",
    l_lang:"Dil",
    l_jd:"Opsiyonel: İş ilanı (uyarlama için)",
    ph_jd:"İş ilanını yapıştır (opsiyonel)",
    l_fullName:"Ad Soyad", ph_fullName:"Volkan Tunç",
    l_title:"Pozisyon / Ünvan", ph_title:"Pazarlama Uzmanı / Frontend Developer",
    l_location:"Konum", ph_location:"Mersin, TR",
    l_email:"E-posta", ph_email:"you@email.com",
    l_phone:"Telefon", ph_phone:"+90 ...",
    l_links:"Linkler (satır satır: Etiket | URL)", ph_links:"LinkedIn | https://linkedin.com/in/...",
    l_skills:"Yetenekler (virgülle ayır)", ph_skills:"SEO, SQL, React, ...",
    l_langs:"Diller (satır satır: Dil | Seviye)", ph_langs:"İngilizce | Native\nTürkçe | Native",
    l_experience:"Deneyim (her rol ayrı blok)",
    ph_experience:
`Seçenek A (başlıklı):
Role: Pazarlama Uzmanı
Company: ABC
Start: 2022
End: Present
Location: Remote
Notes: reklam yönetimi, landing page iyileştirme

Seçenek B (satır satır):
Pazarlama Uzmanı
ABC
2022 - Devam
Remote
reklam yönetimi, landing page iyileştirme`,
    exp_help:"İpucu: İster Role/Company/Start/End/Location/Notes formatını, ister satır satır basit formatı kullan.",
    l_education:"Eğitim (her kayıt ayrı blok)",
    ph_education:
`Seçenek A (başlıklı):
School: Yeditepe Üniversitesi
Degree: İşletme
Start: 2016
End: 2020
Notes: (opsiyonel)

Seçenek B (satır satır):
Yeditepe Üniversitesi
İşletme
2016 - 2020`,
    edu_help:"Opsiyonel. Yoksa boş bırak.",
    l_projects:"Projeler (her proje ayrı blok)",
    ph_projects:
`Seçenek A (başlıklı):
Name: ResumeAI.work
Tech: Next.js, OpenAI API, Upstash
Notes: ATS analiz + PDF export

Seçenek B (satır satır):
ResumeAI.work
Next.js, OpenAI API, Upstash
ATS analiz + PDF export`,
    proj_help:"Tech = virgülle ayır. Notes = ne yaptın; ResumeAI bunu bullet’a çevirir.",
    btn:"CV + PDF üret",
    gen:"Üretiliyor…",
    done:"Bitti ✅ PDF açılıyor…",
    errPrefix:"Hata: ",
    missingBasics:"En az Ad Soyad + Pozisyon alanlarını doldur."
  }
};

// fallback: diğer diller EN kullansın
["es","ru","fr","ar","zh"].forEach(k=>{ I18N[k]=I18N.en; });

function applyLangUI(code){
  const t = I18N[code] || I18N.en;
  const setText = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=val; };
  const setPH = (id,val)=>{ const el=document.getElementById(id); if(el) el.placeholder=val; };

  setText("t_back", t.back);
  setText("t_badge", t.badge);
  setText("t_title", t.title);
  setText("t_sub", t.sub);

  setText("l_lang", t.l_lang);
  setText("l_jd", t.l_jd);
  setPH("jd", t.ph_jd);

  setText("l_fullName", t.l_fullName); setPH("fullName", t.ph_fullName);
  setText("l_title", t.l_title); setPH("title", t.ph_title);
  setText("l_location", t.l_location); setPH("location", t.ph_location);
  setText("l_email", t.l_email); setPH("email", t.ph_email);
  setText("l_phone", t.l_phone); setPH("phone", t.ph_phone);

  setText("l_links", t.l_links); setPH("links", t.ph_links);
  setText("l_skills", t.l_skills); setPH("skills", t.ph_skills);
  setText("l_langs", t.l_langs); setPH("langs", t.ph_langs);

  setText("l_experience", t.l_experience);
  document.getElementById("experience").placeholder = t.ph_experience;
  setText("t_exp_help", t.exp_help);

  setText("l_education", t.l_education);
  document.getElementById("education").placeholder = t.ph_education;
  setText("t_edu_help", t.edu_help);

  setText("l_projects", t.l_projects);
  document.getElementById("projects").placeholder = t.ph_projects;
  setText("t_proj_help", t.proj_help);

  document.getElementById("btn").textContent = t.btn;
}

/** ---------------- parsers ---------------- */
function parseLinks(v){
  const lines = String(v||"").split("\n").map(x=>x.trim()).filter(Boolean);
  return lines.slice(0,6).map(line=>{
    const parts = line.split("|").map(s=>s.trim());
    return { label: parts[0] || "Link", url: parts[1] || "" };
  }).filter(x=>x.url);
}

function parseLangs(v){
  const lines = String(v||"").split("\n").map(x=>x.trim()).filter(Boolean);
  return lines.slice(0,10).map(line=>{
    const parts = line.split("|").map(s=>s.trim());
    return { name: parts[0] || "", level: parts[1] || "" };
  }).filter(x=>x.name);
}

function splitBlocks(v){
  return String(v||"").split(/\n\s*\n/).map(b=>b.trim()).filter(Boolean);
}

function getKV(block, key){
  const m = block.match(new RegExp("^"+key+"\\s*:\\s*(.+)$","im"));
  return m ? m[1].trim() : "";
}

function parseExperience(v){
  const blocks = splitBlocks(v).slice(0,10);
  return blocks.map(b=>{
    const hasKeys = /(^|\n)\s*(Role|Company|Start|End|Location|Notes)\s*:/i.test(b);

    if (hasKeys){
      const notes = getKV(b,"Notes");
      return {
        position: getKV(b,"Role"),
        company: getKV(b,"Company"),
        start: getKV(b,"Start"),
        end: getKV(b,"End") || null,
        location: getKV(b,"Location"),
        highlights: notes ? [notes] : []
      };
    }

    // Simple lines fallback:
    const lines = b.split("\n").map(x=>x.trim()).filter(Boolean);
    const position = lines[0] || "";
    const company  = lines[1] || "";
    // try parse dates from line3 like "2019 - Present" or "2019-2022"
    const dateLine = lines[2] || "";
    let start="", end=null;
    const dm = dateLine.match(/^\s*(\d{4})\s*(?:-|–|to)\s*(\d{4}|present|current|devam|now)\s*$/i);
    if (dm){
      start = dm[1];
      end = /present|current|devam|now/i.test(dm[2]) ? null : dm[2];
    }else{
      start = dateLine; // keep raw if they typed differently
      end = null;
    }
    const location = lines[3] || "";
    const notes = lines.slice(4).join("; ").trim();
    return {
      position, company, start, end, location,
      highlights: notes ? [notes] : []
    };
  }).filter(x=>x.position || x.company);
}

function parseEducation(v){
  const blocks = splitBlocks(v).slice(0,8);
  return blocks.map(b=>{
    const hasKeys = /(^|\n)\s*(School|Degree|Start|End|Notes)\s*:/i.test(b);
    if (hasKeys){
      return {
        school: getKV(b,"School"),
        degree: getKV(b,"Degree"),
        start: getKV(b,"Start"),
        end: getKV(b,"End"),
        notes: getKV(b,"Notes")
      };
    }
    const lines = b.split("\n").map(x=>x.trim()).filter(Boolean);
    return {
      school: lines[0] || "",
      degree: lines[1] || "",
      start: (lines[2] || "").split(/-|–|to/i)[0]?.trim() || "",
      end: (lines[2] || "").split(/-|–|to/i)[1]?.trim() || "",
      notes: lines.slice(3).join("; ").trim()
    };
  }).filter(x=>x.school || x.degree);
}

function parseProjects(v){
  const blocks = splitBlocks(v).slice(0,8);
  return blocks.map(b=>{
    const hasKeys = /(^|\n)\s*(Name|Tech|Notes)\s*:/i.test(b);
    if (hasKeys){
      const tech = getKV(b,"Tech");
      return {
        name: getKV(b,"Name"),
        tech: tech ? tech.split(",").map(x=>x.trim()).filter(Boolean) : [],
        highlights: getKV(b,"Notes") ? [getKV(b,"Notes")] : []
      };
    }
    const lines = b.split("\n").map(x=>x.trim()).filter(Boolean);
    const name = lines[0] || "";
    const tech = (lines[1] || "").split(",").map(x=>x.trim()).filter(Boolean);
    const notes = lines.slice(2).join("; ").trim();
    return { name, tech, highlights: notes ? [notes] : [] };
  }).filter(x=>x.name);
}

/** ---------------- init ---------------- */
const langSel = document.getElementById("lang");
applyLangUI(langSel.value);
langSel.addEventListener("change", ()=>applyLangUI(langSel.value));

/** ---------------- submit ---------------- */
document.getElementById("btn").addEventListener("click", async ()=>{
  const btn = document.getElementById("btn");
  const status = document.getElementById("status");
  const lang = document.getElementById("lang").value;
  const t = I18N[lang] || I18N.en;

  const fullName = document.getElementById("fullName").value.trim();
  const title = document.getElementById("title").value.trim();

  if (!fullName || !title){
    status.classList.add("err");
    status.textContent = t.missingBasics;
    return;
  }

  btn.disabled = true;
  status.classList.remove("err");
  status.textContent = t.gen;

  const jd = document.getElementById("jd").value;

  const profile = {
    fullName,
    title,
    location: document.getElementById("location").value,
    phone: document.getElementById("phone").value,
    email: document.getElementById("email").value,
    links: parseLinks(document.getElementById("links").value),
    skills: String(document.getElementById("skills").value||"").split(",").map(x=>x.trim()).filter(Boolean),
    languages: parseLangs(document.getElementById("langs").value),
    experience: parseExperience(document.getElementById("experience").value),
    education: parseEducation(document.getElementById("education").value).map(e=>({
      school: e.school, degree: e.degree, start: e.start, end: e.end
    })),
    projects: parseProjects(document.getElementById("projects").value),
    certificates: []
  };

  try{
    const r = await fetch("/api/create", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      credentials:"include",
      body: JSON.stringify({ profile, jd, lang, preview:false })
    });

    const data = await r.json().catch(()=> ({}));
    if(!r.ok){
      const msg = data?.error || ("Request failed: " + r.status);
      throw new Error(msg + (data?.details ? (" | " + String(data.details).slice(0,600)) : ""));
    }

    localStorage.setItem("resumeai_cvdata", JSON.stringify(data.cv_data));
    status.textContent = t.done;
    window.location.href = `/cv.html?lang=${encodeURIComponent(lang)}#mode=ats`;
  }catch(e){
    status.classList.add("err");
    status.textContent = t.errPrefix + (e.message || e);
  }finally{
    btn.disabled = false;
  }
});
</script>
</body>
</html>
