<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ResumeAI ‚Äì Analyze</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:Inter,system-ui,Arial;background:#0b0f19;color:#fff;}
    .wrap{max-width:980px;margin:auto;padding:60px 20px;}
    .top{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px;}
    .brand{font-weight:700;font-size:18px;letter-spacing:-0.3px;}
    .brand span{color:#6366F1;}
    a{color:#a0a6b8;text-decoration:none;}
    h1{margin:10px 0 10px 0;font-size:34px;}
    p{color:#a0a6b8;line-height:1.6;margin:0 0 28px 0;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
    textarea{
      width:100%;min-height:260px;resize:vertical;
      background:#111827;border:1px solid rgba(255,255,255,0.08);
      color:#fff;border-radius:14px;padding:14px;font-size:14px;line-height:1.5;
      outline:none;
    }
    textarea:focus{border-color:rgba(99,102,241,0.55);}
    .actions{display:flex;gap:12px;align-items:center;margin-top:16px; flex-wrap:wrap;}
    button{
      padding:14px 18px;border:0;border-radius:12px;
      background:linear-gradient(135deg,#7b5cff,#5b3dff);
      color:#fff;font-weight:700;font-size:15px;cursor:pointer;
    }
    button:disabled{opacity:0.6;cursor:not-allowed;}
    .hint{color:#6b7280;font-size:13px;}
    .out{margin-top:30px;background:#0f1524;border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:18px;}
    .row{display:flex;gap:16px;flex-wrap:wrap;}
    .pill{background:rgba(99,102,241,0.10);border:1px solid rgba(99,102,241,0.22);padding:8px 12px;border-radius:999px;color:#e5e7eb;font-weight:600;}

    /* Daha dikkat √ßekici ATS score */
    .scorePill{
      font-size: 18px;
      font-weight: 800;
      padding: 12px 16px;
      border-radius: 999px;
      letter-spacing: .2px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      background: linear-gradient(135deg, rgba(99,102,241,.35), rgba(124,58,237,.28));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 30px rgba(99,102,241,.18);
    }
    .scoreDot{
      width: 12px;height: 12px;border-radius: 999px;
      background: #6366F1;
      box-shadow: 0 0 0 6px rgba(99,102,241,.18);
    }
    .scoreValue{font-weight: 900;font-size: 20px;}
    .score-low  { background: linear-gradient(135deg, rgba(239,68,68,.28), rgba(251,146,60,.18)); box-shadow: 0 10px 30px rgba(239,68,68,.16); }
    .score-mid  { background: linear-gradient(135deg, rgba(245,158,11,.28), rgba(234,179,8,.18)); box-shadow: 0 10px 30px rgba(245,158,11,.16); }
    .score-high { background: linear-gradient(135deg, rgba(34,197,94,.22), rgba(16,185,129,.16)); box-shadow: 0 10px 30px rgba(34,197,94,.14); }

    .sec{margin-top:16px;}
    .sec h3{margin:0 0 10px 0;font-size:16px;}
    ul{margin:0;padding-left:18px;color:#d1d5db;line-height:1.7;}
    pre{
      white-space:pre-wrap;word-wrap:break-word;
      background:#0b0f19;border:1px solid rgba(255,255,255,0.06);
      padding:14px;border-radius:14px;color:#e5e7eb;line-height:1.6;
    }
    @media(max-width:900px){.grid{grid-template-columns:1fr;}}
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">Resume<span>AI</span></div>
      <a href="/index.html">‚Üê Back</a>
    </div>
    <div id="langLabel" style="margin-top:8px;margin-bottom:8px;font-size:16px;color:#cbd5e1;font-weight:800;letter-spacing:.2px;">
  Select language
</div>
    <div id="langBar" style="position:sticky; top:0; z-index:999; margin:12px 0; padding:10px; display:flex; gap:10px; flex-wrap:wrap; background:rgba(17,24,39,.92); border:1px solid rgba(255,255,255,.12); border-radius:14px; backdrop-filter: blur(8px);"></div>

    <h1>ATS Analysis</h1>
    <p>Paste your resume and the job description. We‚Äôll return a structured analysis + optimized version.</p>

    <div id="previewBanner" style="display:none; margin:14px 0; padding:12px 14px; border:1px dashed rgba(255,255,255,.25); border-radius:14px; background:rgba(255,255,255,.04);">
      <div style="font-weight:800; font-size:14px;">üîí Free Preview Mode ‚Äî only 20% shown</div>
      <div style="opacity:.85; font-size:13px; margin-top:6px;">
        Full report is locked: all missing keywords, all rewrites, and the complete optimized resume.
      </div>
      <a href="https://resumeaiwork.lemonsqueezy.com/checkout/buy/9eb87229-c603-4956-80db-1a804afa81ec"
   style="display:inline-block; margin-top:10px; padding:10px 12px; border-radius:12px; background:#7c3aed; color:white; font-weight:800; text-decoration:none;">
  Unlock Lifetime Access
</a>
    </div>

    <div class="grid">
      <div>
        <div class="hint" style="margin-bottom:8px;">Resume (paste text)</div>
        <textarea id="resume" placeholder="Paste your resume here..."></textarea>
      </div>
      <div>
        <div class="hint" style="margin-bottom:8px;">Job description (paste text)</div>
        <textarea id="job" placeholder="Paste the job description here..."></textarea>
      </div>
    </div>

    <div class="actions">
  <button id="btn">Analyze</button>

  <!-- ‚úÖ BURAYA EKLE -->
  <div id="spinner" style="display:none;width:18px;height:18px;border:3px solid rgba(255,255,255,.25);border-top-color:#6366F1;border-radius:999px;animation:spin .8s linear infinite;"></div>

  <div class="hint" id="status"></div>
</div>

    <div class="out" id="out" style="display:none;">
      <div class="row">
        <div class="pill scorePill" id="scorePill">ATS Match Score: ‚Äî</div>
      </div>

      <div class="actions" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" type="button" id="copyMissing">Copy Keywords</button>
        <button class="btn" type="button" id="copyWeak">Copy Weak</button>
        <button class="btn" type="button" id="copyOptimized">Copy Optimized</button>
        <button class="btn btn-ghost" type="button" id="downloadAts">Download ATS PDF</button>
        <button class="btn btn-ghost" type="button" id="downloadModern">Download Modern PDF</button>
      </div>

      <div class="sec">
        <h3>Missing Keywords</h3>
        <div id="kwPreviewNote" style="display:none; opacity:.8; font-size:13px; margin:6px 0 10px 0;">
          Preview shows only the first 5 keywords. Unlock to see the full list.
        </div>
        <ul id="missing"></ul>
      </div>

      <div class="sec">
        <h3>Weak / Vague Phrases <span id="lockWeak" style="display:none;">üîí</span></h3>
        <ul id="weak"></ul>
      </div>

      <div class="sec">
        <h3>Optimized Resume (ATS + Recruiter-ready) <span id="lockOpt" style="display:none;">üîí</span></h3>
        <pre id="optimized"></pre>
      </div>
    </div>
  </div>

<script>
/* =======================
   PROBE + global error
======================= */
(function () {
  const s = document.getElementById("status");
  if (s) s.textContent = "JS LOADED ‚úÖ";
  console.log("JS LOADED ‚úÖ", new Date().toISOString());
})();
window.onerror = function (msg, src, line, col) {
  const s = document.getElementById("status");
  if (s) s.textContent = "JS ERROR: " + msg + " (line " + line + ")";
};

/* =======================
   Unlock state from server
======================= */
async function fetchUnlockState() {
  try {
    const r = await fetch("/api/me", { method: "GET", credentials: "include" });
    const j = await r.json().catch(() => ({}));
    window.__unlocked = !!j.unlocked;
  } catch {
    window.__unlocked = false;
  }
}

/* =======================
   Lemon paid=1 => confirm
   IMPORTANT: after 200 ‚Üí full navigation to apply cookie reliably
======================= */
(async function confirmIfPaid() {
  try {
    const qs = new URLSearchParams(location.search);
    if (qs.get("paid") !== "1") return;

    const order_id = qs.get("order_id") || "";
    const email = qs.get("email") || "";
    if (!email) return;

    const r = await fetch(
      `/api/confirm?order_id=${encodeURIComponent(order_id)}&email=${encodeURIComponent(email)}`,
      { method: "GET", credentials: "include" }
    );

    if (!r.ok) {
      const t = await r.text();
      throw new Error("confirm failed: " + t);
    }

    // UX: localStorage sadece UI i√ßindir; ger√ßek unlock server cookie ile
    localStorage.setItem("resumeai_unlocked", "1");

    // üî• CRITICAL: cookie'yi garanti kullanmak i√ßin tam sayfa y√∂nlendirme
    window.location.replace("/analyze.html");
  } catch (e) {
    console.warn(e);
    const s = document.getElementById("status");
    if (s) s.textContent = "Confirm error. Check /api/confirm logs.";
  }
})();

/* =======================
   i18n (FULL only)
======================= */
(function applyAnalyzeI18n(){
  const qs = new URLSearchParams(location.search);
  const lang = (qs.get("lang") || "en").toLowerCase();

  const I18N = {
    en: { back:"‚Üê Back", title:"ATS Analysis", subtitle:"Paste your resume and the job description. We‚Äôll return a structured analysis + optimized version.", resumeHint:"Resume (paste text)", resumePh:"Paste your resume here...", jobHint:"Job description (paste text)", jobPh:"Paste the job description here...", analyze:"Analyze", done:"Done.", scoreLabel:"ATS Match Score:", missing:"Missing Keywords", weak:"Weak / Vague Phrases", optimized:"Optimized Resume (ATS + Recruiter-ready)", copyKw:"Copy Keywords", copyWeak:"Copy Weak", copyOpt:"Copy Optimized", dlAts:"Download ATS PDF", dlModern:"Download Modern PDF", needBoth:"Please paste both resume and job description.", langLabel:"Select language" },
    tr: { back:"‚Üê Geri", title:"ATS Analizi", subtitle:"CV‚Äônizi ve i≈ü ilanƒ±nƒ± yapƒ±≈ütƒ±rƒ±n. Yapƒ±landƒ±rƒ±lmƒ±≈ü analiz + optimize edilmi≈ü CV d√∂nd√ºrelim.", resumeHint:"CV (metin yapƒ±≈ütƒ±r)", resumePh:"CV‚Äônizi buraya yapƒ±≈ütƒ±rƒ±n...", jobHint:"ƒ∞≈ü ilanƒ± (metin yapƒ±≈ütƒ±r)", jobPh:"ƒ∞≈ü ilanƒ±nƒ± buraya yapƒ±≈ütƒ±rƒ±n...", analyze:"Analiz Et", done:"Tamamlandƒ±.", scoreLabel:"ATS Uyum Skoru:", missing:"Eksik Anahtar Kelimeler", weak:"Zayƒ±f / Belirsiz ƒ∞fadeler", optimized:"Optimize CV (ATS + Recruiter-ready)", copyKw:"Kelimeleri Kopyala", copyWeak:"Zayƒ±flarƒ± Kopyala", copyOpt:"Optimizeyi Kopyala", dlAts:"ATS PDF ƒ∞ndir", dlModern:"Modern PDF ƒ∞ndir", needBoth:"L√ºtfen hem CV hem i≈ü ilanƒ±nƒ± yapƒ±≈ütƒ±rƒ±n.", langLabel:"Dil se√ß" },
    es: { back:"‚Üê Volver", title:"An√°lisis ATS", subtitle:"Pega tu CV y la descripci√≥n del puesto. Devolveremos un an√°lisis estructurado + CV optimizado.", resumeHint:"CV (pegar texto)", resumePh:"Pega tu CV aqu√≠...", jobHint:"Descripci√≥n del puesto (pegar texto)", jobPh:"Pega la descripci√≥n del puesto aqu√≠...", analyze:"Analizar", done:"Listo.", scoreLabel:"Puntuaci√≥n ATS:", missing:"Palabras clave faltantes", weak:"Frases d√©biles / vagas", optimized:"CV optimizado (ATS + listo para reclutador)", copyKw:"Copiar keywords", copyWeak:"Copiar d√©biles", copyOpt:"Copiar optimizado", dlAts:"Descargar PDF ATS", dlModern:"Descargar PDF Moderno", needBoth:"Por favor pega el CV y la descripci√≥n.", langLabel:"Seleccionar idioma" },
    ru: { back:"‚Üê –ù–∞–∑–∞–¥", title:"ATS –ê–Ω–∞–ª–∏–∑", subtitle:"–í—Å—Ç–∞–≤—å—Ç–µ —Ä–µ–∑—é–º–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏. –í–µ—Ä–Ω—ë–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ + –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ.", resumeHint:"–†–µ–∑—é–º–µ (–≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç)", resumePh:"–í—Å—Ç–∞–≤—å—Ç–µ —Ä–µ–∑—é–º–µ –∑–¥–µ—Å—å...", jobHint:"–û–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ (–≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç)", jobPh:"–í—Å—Ç–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –∑–¥–µ—Å—å...", analyze:"–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å", done:"–ì–æ—Ç–æ–≤–æ.", scoreLabel:"ATS –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ:", missing:"–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞", weak:"–°–ª–∞–±—ã–µ / —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏", optimized:"–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ (ATS + recruiter-ready)", copyKw:"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ", copyWeak:"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–ª–∞–±—ã–µ", copyOpt:"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º.", dlAts:"–°–∫–∞—á–∞—Ç—å ATS PDF", dlModern:"–°–∫–∞—á–∞—Ç—å Modern PDF", needBoth:"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –≤—Å—Ç–∞–≤—å—Ç–µ –∏ —Ä–µ–∑—é–º–µ, –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏.", langLabel:"–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫" },
    fr: { back:"‚Üê Retour", title:"Analyse ATS", subtitle:"Collez votre CV et l‚Äôoffre d‚Äôemploi. Nous renverrons une analyse structur√©e + un CV optimis√©.", resumeHint:"CV (coller le texte)", resumePh:"Collez votre CV ici...", jobHint:"Offre d‚Äôemploi (coller le texte)", jobPh:"Collez l‚Äôoffre d‚Äôemploi ici...", analyze:"Analyser", done:"Termin√©.", scoreLabel:"Score ATS :", missing:"Mots-cl√©s manquants", weak:"Phrases faibles / vagues", optimized:"CV optimis√© (ATS + recruiter-ready)", copyKw:"Copier mots-cl√©s", copyWeak:"Copier faibles", copyOpt:"Copier optimis√©", dlAts:"T√©l√©charger ATS PDF", dlModern:"T√©l√©charger Modern PDF", needBoth:"Veuillez coller le CV et l‚Äôoffre d‚Äôemploi.", langLabel:"Choisir la langue" },
    ar: { back:"‚Üê ÿ±ÿ¨Ÿàÿπ", title:"ÿ™ÿ≠ŸÑŸäŸÑ ATS", subtitle:"ÿßŸÑÿµŸÇ ÿßŸÑÿ≥Ÿäÿ±ÿ© ÿßŸÑÿ∞ÿßÿ™Ÿäÿ© ŸàŸàÿµŸÅ ÿßŸÑŸàÿ∏ŸäŸÅÿ©. ÿ≥ŸÜÿπŸäÿØ ÿ™ÿ≠ŸÑŸäŸÑÿßŸã ŸÖŸÜÿ∏ŸÖÿßŸã + ÿ≥Ÿäÿ±ÿ© ŸÖÿ≠ÿ≥ŸëŸÜÿ©.", resumeHint:"ÿßŸÑÿ≥Ÿäÿ±ÿ© ÿßŸÑÿ∞ÿßÿ™Ÿäÿ© (ÿßŸÑÿµŸÇ ÿßŸÑŸÜÿµ)", resumePh:"ÿßŸÑÿµŸÇ ÿßŸÑÿ≥Ÿäÿ±ÿ© ÿßŸÑÿ∞ÿßÿ™Ÿäÿ© ŸáŸÜÿß...", jobHint:"ŸàÿµŸÅ ÿßŸÑŸàÿ∏ŸäŸÅÿ© (ÿßŸÑÿµŸÇ ÿßŸÑŸÜÿµ)", jobPh:"ÿßŸÑÿµŸÇ ŸàÿµŸÅ ÿßŸÑŸàÿ∏ŸäŸÅÿ© ŸáŸÜÿß...", analyze:"ÿ™ÿ≠ŸÑŸäŸÑ", done:"ÿ™ŸÖ.", scoreLabel:"ÿØÿ±ÿ¨ÿ© ÿ™ŸàÿßŸÅŸÇ ATS:", missing:"ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠Ÿäÿ© ÿßŸÑŸÜÿßŸÇÿµÿ©", weak:"ÿπÿ®ÿßÿ±ÿßÿ™ ÿ∂ÿπŸäŸÅÿ© / ÿ∫Ÿäÿ± Ÿàÿßÿ∂ÿ≠ÿ©", optimized:"ÿ≥Ÿäÿ±ÿ© ŸÖÿ≠ÿ≥ŸëŸÜÿ© (ATS + ÿ¨ÿßŸáÿ≤ÿ© ŸÑŸÑÿ™Ÿàÿ∏ŸäŸÅ)", copyKw:"ŸÜÿ≥ÿÆ ÿßŸÑŸÉŸÑŸÖÿßÿ™", copyWeak:"ŸÜÿ≥ÿÆ ÿßŸÑÿ∂ÿπŸäŸÅÿ©", copyOpt:"ŸÜÿ≥ÿÆ ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜÿ©", dlAts:"ÿ™ÿ≠ŸÖŸäŸÑ ATS PDF", dlModern:"ÿ™ÿ≠ŸÖŸäŸÑ Modern PDF", needBoth:"Ÿäÿ±ÿ¨Ÿâ ŸÑÿµŸÇ ÿßŸÑÿ≥Ÿäÿ±ÿ© ŸàŸàÿµŸÅ ÿßŸÑŸàÿ∏ŸäŸÅÿ©.", langLabel:"ÿßÿÆÿ™ÿ± ÿßŸÑŸÑÿ∫ÿ©" },
    zh: { back:"‚Üê ËøîÂõû", title:"ATS ÂàÜÊûê", subtitle:"Á≤òË¥¥ÁÆÄÂéÜ‰∏éËÅå‰ΩçÊèèËø∞ÔºåÊàë‰ª¨Â∞ÜËøîÂõûÁªìÊûÑÂåñÂàÜÊûê + ‰ºòÂåñÂêéÁöÑÁÆÄÂéÜ„ÄÇ", resumeHint:"ÁÆÄÂéÜÔºàÁ≤òË¥¥ÊñáÊú¨Ôºâ", resumePh:"Âú®ËøôÈáåÁ≤òË¥¥‰Ω†ÁöÑÁÆÄÂéÜ...", jobHint:"ËÅå‰ΩçÊèèËø∞ÔºàÁ≤òË¥¥ÊñáÊú¨Ôºâ", jobPh:"Âú®ËøôÈáåÁ≤òË¥¥ËÅå‰ΩçÊèèËø∞...", analyze:"ÂàÜÊûê", done:"ÂÆåÊàê„ÄÇ", scoreLabel:"ATS ÂåπÈÖçÂ∫¶Ôºö", missing:"Áº∫Â§±ÂÖ≥ÈîÆËØç", weak:"ËñÑÂº±/Ê®°Á≥äË°®Ëø∞", optimized:"‰ºòÂåñÁÆÄÂéÜÔºàATS + ÊãõËÅòÂèØÁî®Ôºâ", copyKw:"Â§çÂà∂ÂÖ≥ÈîÆËØç", copyWeak:"Â§çÂà∂ËñÑÂº±È°π", copyOpt:"Â§çÂà∂‰ºòÂåñÁÆÄÂéÜ", dlAts:"‰∏ãËΩΩ ATS PDF", dlModern:"‰∏ãËΩΩ Modern PDF", needBoth:"ËØ∑ÂêåÊó∂Á≤òË¥¥ÁÆÄÂéÜÂíåËÅå‰ΩçÊèèËø∞„ÄÇ", langLabel:"ÈÄâÊã©ËØ≠Ë®Ä" }
  };

  const t = I18N[lang] || I18N.en;

  const setText = (sel, val) => { const el = document.querySelector(sel); if (el) el.textContent = val; };
  const setPh   = (sel, val) => { const el = document.querySelector(sel); if (el) el.setAttribute("placeholder", val); };

  setText('.top a[href="/index.html"]', t.back);
  setText("#langLabel", t.langLabel);
  setText("h1", t.title);

  const p = document.querySelector("h1 + p");
  if (p) p.textContent = t.subtitle;

  const hintEls = document.querySelectorAll(".grid .hint");
  if (hintEls[0]) hintEls[0].textContent = t.resumeHint;
  if (hintEls[1]) hintEls[1].textContent = t.jobHint;

  setPh("#resume", t.resumePh);
  setPh("#job", t.jobPh);

  setText("#btn", t.analyze);

  const h3s = document.querySelectorAll(".out .sec h3");
  if (h3s[0]) h3s[0].childNodes[0].textContent = t.missing;
  if (h3s[1]) h3s[1].childNodes[0].textContent = t.weak + " ";
  if (h3s[2]) h3s[2].childNodes[0].textContent = t.optimized + " ";

  setText("#copyMissing", t.copyKw);
  setText("#copyWeak", t.copyWeak);
  setText("#copyOptimized", t.copyOpt);
  setText("#downloadAts", t.dlAts);
  setText("#downloadModern", t.dlModern);

  window.__scoreLabel = t.scoreLabel;
  window.__needBoth = t.needBoth;
  window.__doneText = t.done;
})();

/* =======================
   Preview UI sync with server
======================= */
async function syncPreviewUI() {
  await fetchUnlockState();

  const forcedPreview = new URLSearchParams(location.search).get("preview") === "1";
  const isPreview = forcedPreview || !window.__unlocked;

  // Banner / Locks UI
  const banner = document.getElementById("previewBanner");
  const kwNote = document.getElementById("kwPreviewNote");
  const lw = document.getElementById("lockWeak");
  const lo = document.getElementById("lockOpt");

  if (banner) banner.style.display = isPreview ? "block" : "none";
  if (kwNote) kwNote.style.display = isPreview ? "block" : "none";
  if (lw) lw.style.display = isPreview ? "inline" : "none";
  if (lo) lo.style.display = isPreview ? "inline" : "none";

  window.__isPreview = isPreview;

  const s = document.getElementById("status");
  if (s) s.textContent = isPreview ? "Preview Mode üîí" : "Full Mode ‚úÖ";
}

/* =======================
   run()
======================= */
async function run(){
  const resume = document.getElementById('resume').value.trim();
  const job = document.getElementById('job').value.trim();
  const btn = document.getElementById('btn');
  const status = document.getElementById('status');
  const spinner = document.getElementById("spinner");

  const qs = new URLSearchParams(location.search);
  const lang = qs.get("lang") || "en";

  // üî• preview server-state driven (forced by ?preview=1 OR locked)
  const isPreview = !!window.__isPreview;

  if(!resume || !job){
    status.textContent = window.__needBoth || "Please paste both resume and job description.";
    return;
  }

  btn.disabled = true;
  status.textContent = "";
  document.getElementById('out').style.display = "none";
  if (spinner) spinner.style.display = "inline-flex";

  try {
    const r = await fetch("/api/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ cv: resume, jd: job, preview: isPreview, lang })
    });

    const rawText = await r.text();
    let data = {};
    try { data = JSON.parse(rawText); } catch {}

    if (!r.ok) {
      if (r.status === 429) {
        const sec = Number(data?.retry_after_seconds || 0);
        if (isPreview) {
          const min = Math.max(1, Math.ceil(sec / 60));
          status.textContent = `Preview limit: please wait ${min} minute(s) and try again.`;
          return;
        } else {
          status.textContent = `Please wait ${sec}s and try again.`;
          return;
        }
      }
      const msg = data?.details || data?.model_output || data?.error || rawText || "Request failed";
      throw new Error(msg);
    }

    // SCORE
    const pill = document.getElementById('scorePill');
    const score = Number(data.ats_score || 0);
    const label = window.__scoreLabel || "ATS Match Score:";
    pill.classList.remove("score-low","score-mid","score-high");
    pill.classList.add(score >= 70 ? "score-high" : score >= 45 ? "score-mid" : "score-low");
    pill.innerHTML = `<span class="scoreDot"></span><span>${label}</span><span class="scoreValue">${score}%</span>`;

    // missing keywords
    const missing = document.getElementById('missing');
    missing.innerHTML = "";
    (data.missing_keywords || []).forEach(k=>{
      const li = document.createElement('li');
      li.textContent = k;
      missing.appendChild(li);
    });

    // weak
    const weak = document.getElementById('weak');
    weak.innerHTML = "";
    if (isPreview) {
      weak.innerHTML = "<li>üîí Preview: Weak phrases are locked. Unlock to see full rewrites.</li>";
    } else {
      (data.weak_sentences || []).forEach(it=>{
        const li = document.createElement('li');
        li.textContent = (it && it.sentence && it.rewrite) ? `${it.sentence} ‚Üí ${it.rewrite}` : String(it);
        weak.appendChild(li);
      });
    }

    // optimized
    document.getElementById('optimized').textContent = isPreview
      ? "üîí Preview: Optimized resume is locked. Unlock to generate the full ATS-optimized version."
      : (data.optimized_cv || "");

    document.getElementById('out').style.display = "block";
    status.textContent = window.__doneText || "Done.";
  } catch(e){
    status.textContent = "Error: " + (e.message || e);
  } finally{
    btn.disabled = false;
    if (spinner) spinner.style.display = "none";
  }
}

/* =======================
   Bind button click + init
======================= */
document.addEventListener("DOMContentLoaded", async () => {
  await syncPreviewUI();
  const btn = document.getElementById("btn");
  if (!btn) return;
  btn.addEventListener("click", () => {
    const s = document.getElementById("status");
    if (s) s.textContent = "CLICK ‚úÖ running...";
    run();
  });
});

/* =======================
   Lang bar renderer (keep preview param if present)
======================= */
(function(){
  const bar = document.getElementById("langBar");
  if (!bar) return;

  const qs = new URLSearchParams(window.location.search);
  const current = qs.get("lang") || "en";
  const preview = qs.get("preview"); // varsa "1"

  const langs = [
    ["en","EN"],["tr","TR"],["es","ES"],["ru","RU"],["fr","FR"],["ar","AR"],["zh","‰∏≠Êñá"]
  ];

  function buildHref(langCode){
    const p = new URLSearchParams();
    if (preview) p.set("preview", preview);
    p.set("lang", langCode);
    return window.location.pathname + "?" + p.toString();
  }

  bar.innerHTML = "";
  langs.forEach(([code,label])=>{
    const a = document.createElement("a");
    a.style.cssText = (code === current)
      ? "opacity:1;font-weight:900;padding:10px 12px;font-size:14px;border-radius:12px;background:rgba(109,94,252,.95);color:#fff;border:1px solid rgba(255,255,255,.18);"
      : "opacity:.85;padding:10px 12px;font-size:14px;border-radius:12px;background:transparent;color:#cbd5e1;border:1px solid rgba(255,255,255,.22);";
    a.href = buildHref(code);
    a.textContent = label;
    bar.appendChild(a);
  });
})();

/* =======================
   Copy helpers
======================= */
function copyText(text){
  if (!text) return alert("Nothing to copy.");
  navigator.clipboard.writeText(text)
    .then(()=> alert("Copied ‚úÖ"))
    .catch(()=> alert("Copy failed (iOS sometimes blocks)."));
}

document.getElementById("copyMissing")?.addEventListener("click", ()=>{
  const items = [...document.querySelectorAll("#missing li")]
    .map(li=>li.textContent.trim()).filter(Boolean);
  copyText(items.map(x=>"- " + x).join("\n"));
});

document.getElementById("copyWeak")?.addEventListener("click", ()=>{
  const items = [...document.querySelectorAll("#weak li")]
    .map(li=>li.textContent.trim()).filter(Boolean);
  copyText(items.map(x=>"- " + x).join("\n"));
});

document.getElementById("copyOptimized")?.addEventListener("click", ()=>{
  const text = (document.getElementById("optimized")?.textContent || "").trim();
  copyText(text);
});

/* =======================
   Downloads (localStorage -> cv.html)
======================= */
function getOptimizedTextClean(){
  let optimized = (document.getElementById("optimized")?.textContent || "");
  optimized = optimized.replace(/\n?\s*META\s*:[\s\S]*$/i, "");
  optimized = optimized.replace(/\n?\s*META\s*\{[\s\S]*$/i, "");
  return optimized.trim();
}

function buildCvDataFromOptimizedText(optimizedText){
  const text = String(optimizedText || "").replace(/\r/g, "").trim();
  const lines = text.split("\n").map(l => l.trim()).filter(Boolean);

  const norm = (s) => String(s || "").trim();

  const isHeading = (l) => {
    const u = l.toUpperCase().replace(/[:Ôºö]$/, "").trim();
    const H = new Set([
      "CONTACT","ƒ∞LETƒ∞≈ûƒ∞M","ILETISIM",
      "SUMMARY","PROFESSIONAL SUMMARY","√ñZET","OZET",
      "EXPERIENCE","WORK EXPERIENCE","ƒ∞≈û DENEYƒ∞Mƒ∞","IS DENEYIMI","DENEYƒ∞M","DENEYIM",
      "SKILLS","CORE SKILLS","YETKƒ∞NLƒ∞KLER","YETKINLIKLER",
      "PROJECTS","PROJELER",
      "EDUCATION","Eƒûƒ∞Tƒ∞M","EGITIM",
      "CERTIFICATIONS","CERTIFICATES","SERTƒ∞Fƒ∞KALAR","SERTIFIKALAR",
      "LANGUAGES","Dƒ∞LLER","DILLER"
    ]);
    return H.has(u);
  };

  const headingKey = (l) => {
    const u = l.toUpperCase().replace(/[:Ôºö]$/, "").trim();
    if (["CONTACT","ƒ∞LETƒ∞≈ûƒ∞M","ILETISIM"].includes(u)) return "contact";
    if (["SUMMARY","PROFESSIONAL SUMMARY","√ñZET","OZET"].includes(u)) return "summary";
    if (["SKILLS","CORE SKILLS","YETKƒ∞NLƒ∞KLER","YETKINLIKLER"].includes(u)) return "skills";
    if (["EXPERIENCE","WORK EXPERIENCE","ƒ∞≈û DENEYƒ∞Mƒ∞","IS DENEYIMI","DENEYƒ∞M","DENEYIM"].includes(u)) return "experience";
    if (["PROJECTS","PROJELER"].includes(u)) return "projects";
    if (["EDUCATION","Eƒûƒ∞Tƒ∞M","EGITIM"].includes(u)) return "education";
    if (["CERTIFICATIONS","CERTIFICATES","SERTƒ∞Fƒ∞KALAR","SERTIFIKALAR"].includes(u)) return "certificates";
    if (["LANGUAGES","Dƒ∞LLER","DILLER"].includes(u)) return "languages";
    return "other";
  };

  const isBullet = (l) => /^[-‚Ä¢¬∑‚Ä£‚ñ™‚ñ´‚ó¶]\s+/.test(l);
  const stripBullet = (l) => l.replace(/^[-‚Ä¢¬∑‚Ä£‚ñ™‚ñ´‚ó¶]\s+/, "").trim();

  const pickEmail = () => {
    const joined = lines.join(" ");
    const m = joined.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
    return m ? m[0] : "";
  };

  const pickPhone = () => {
    const joined = lines.join(" ");
    const m = joined.match(/(\+?\d[\d\s().-]{7,}\d)/);
    return m ? m[1].trim() : "";
  };

  const pickLocation = () => {
    for (const l of lines.slice(0, 10)) {
      if (isHeading(l) || isBullet(l)) continue;
      if (/[A-Za-z√áƒûƒ∞√ñ≈û√ú√ßƒüƒ±√∂≈ü√º]+,\s*[A-Za-z√áƒûƒ∞√ñ≈û√ú√ßƒüƒ±√∂≈ü√º]+/.test(l)) return l;
    }
    return "";
  };

  // sectionize
  const sections = {
    contact: [],
    summary: [],
    skills: [],
    experience: [],
    projects: [],
    education: [],
    certificates: [],
    languages: [],
    other: []
  };

  let cur = "other";
for (const l of lines) {
  // 1) Normal ba≈ülƒ±k satƒ±rƒ±: "SKILLS"
  if (isHeading(l)) {
    cur = headingKey(l);
    continue;
  }

  // 2) Inline ba≈ülƒ±k: "SKILLS: SEO, PPC, GA4"  veya "SUMMARY: ...."
  const m = l.match(/^(.{2,40}?)[\s]*[:Ôºö][\s]*(.+)$/);
  if (m) {
    const head = m[1].trim();
    const rest = m[2].trim();

    if (isHeading(head)) {
      cur = headingKey(head);
      if (rest) sections[cur].push(rest);
      continue;
    }
  }

  sections[cur].push(l);
}

  // basics: fullName/title
  let fullName = "";
  let title = "";

  for (const l of lines.slice(0, 8)) {
    if (isHeading(l) || isBullet(l)) continue;
    if (/@/.test(l)) continue;

    if (!fullName && /^[A-Za-z√áƒûƒ∞√ñ≈û√ú√ßƒüƒ±√∂≈ü√º]+(?:\s+[A-Za-z√áƒûƒ∞√ñ≈û√ú√ßƒüƒ±√∂≈ü√º'.-]+){1,3}$/.test(l)) {
      fullName = l;
      continue;
    }
    if (fullName && !title && l !== fullName && l.length <= 60 && !/[,|]/.test(l)) {
      title = l;
      break;
    }
  }

  const email = pickEmail();
  const phone = pickPhone();
  const location = pickLocation();

  // summary
  const summary = (sections.summary || [])
    .map(l => isBullet(l) ? stripBullet(l) : l)
    .join("\n")
    .trim();

  // skills
  let skills = [];
  for (const l of (sections.skills || [])) {
    if (isBullet(l)) skills.push(stripBullet(l));
    else if (l.includes(",")) l.split(",").map(x => x.trim()).filter(Boolean).forEach(x => skills.push(x));
    else skills.push(l);
  }
  skills = [...new Set(skills.map(norm).filter(Boolean))];

  // experience parser
  function parseDateRange(s){
    const t = String(s || "").replace(/\u2013|\u2014/g, "-").replace(/\s+/g, " ").trim();
    const m = t.match(/(\b\d{4}\b|\b[A-Za-z]{3,9}\s+\d{4}\b)\s*-\s*(Present|\b\d{4}\b|\b[A-Za-z]{3,9}\s+\d{4}\b)/i);
    if (!m) return { start:"", end:"" };
    return { start:m[1], end:m[2] };
  }

  const experience = [];
  const expLines = sections.experience || [];
  let i = 0;

  while (i < expLines.length) {
    const roleLine = expLines[i];
    if (isBullet(roleLine) || isHeading(roleLine)) { i++; continue; }

    const role = roleLine;
    let company = "", start = "", end = "";
    const bullets = [];

    const next = expLines[i+1] || "";
    const next2 = expLines[i+2] || "";

    if (next && !isBullet(next) && (next.includes("|") || /\b\d{4}\b/.test(next))) {
      if (next.includes("|")) {
        const [cPart, dPart] = next.split("|").map(s => s.trim());
        company = cPart || "";
        const dr = parseDateRange(dPart || "");
        start = dr.start; end = dr.end;
      } else {
        const dr = parseDateRange(next);
        start = dr.start; end = dr.end;
        company = next.replace(/(\b\d{4}\b.*)$/,"").trim();
      }
      i += 2;
    } else if (next && !isBullet(next) && next2 && !isBullet(next2) && /\b\d{4}\b/.test(next2)) {
      company = next.trim();
      const dr = parseDateRange(next2);
      start = dr.start; end = dr.end;
      i += 3;
    } else {
      i += 1;
    }

    while (i < expLines.length) {
      const l = expLines[i];
      if (isHeading(l)) break;

      const nl = expLines[i+1] || "";
      if (!isBullet(l) && nl && !isBullet(nl) && (nl.includes("|") || /\b\d{4}\b/.test(nl))) break;

      if (isBullet(l)) bullets.push(stripBullet(l));
      i++;
    }

    if (role || company || bullets.length) {
      experience.push({
        title: role || "",
        company: company || "",
        start: start || "",
        end: end || "",
        location: "",
        bullets: bullets.filter(Boolean)
      });
    }
  }

  // projects
  const projects = [];
  const projLines = sections.projects || [];
  if (projLines.length) {
    let curP = null;
    for (const l of projLines) {
      if (!isBullet(l)) {
        if (curP) projects.push(curP);
        curP = { name: l, description: "", bullets: [] };
      } else if (curP) {
        curP.bullets.push(stripBullet(l));
      }
    }
    if (curP) projects.push(curP);
  }

  // education
  const education = [];
  const eduLines = sections.education || [];
  if (eduLines.length) {
    let curE = null;
    for (const l of eduLines) {
      if (isBullet(l)) continue;

      if (!curE) curE = { school: l, degree: "", start: "", end: "", details: [] };
      else if (/\b(19|20)\d{2}\b/.test(l) && !curE.start) {
        const dr = parseDateRange(l);
        curE.start = dr.start; curE.end = dr.end;
      } else if (!curE.degree && l.length <= 80) {
        curE.degree = l;
      } else {
        curE.details.push(l);
      }
    }
    if (curE) education.push(curE);
  }

  // certificates
  const certificates = [];
  const certLines = sections.certificates || [];
  for (const l of certLines) {
    certificates.push({ name: isBullet(l) ? stripBullet(l) : l, issuer: "", year: "" });
  }

  // languages
  let languages = [];
  const langLines = sections.languages || [];
  for (const l of langLines) {
    if (isBullet(l)) languages.push(stripBullet(l));
    else if (l.includes(",")) l.split(",").map(x=>x.trim()).filter(Boolean).forEach(x=>languages.push(x));
    else languages.push(l);
  }
  languages = [...new Set(languages.map(norm).filter(Boolean))];

  // fallback name from email prefix
  if (!fullName && email) {
    const p = email.split("@")[0].replace(/[._-]+/g, " ").trim();
    if (p && p.length <= 40) fullName = p.split(" ").map(w => w ? (w[0].toUpperCase()+w.slice(1)) : "").join(" ");
  }

  return {
    basics: {
      fullName: fullName || "Your Name",
      title: title || "",
      location: location || "",
      phone: phone || "",
      email: email || "",
      links: [],
      photoUrl: ""
    },
    summary: summary || "",
    skills,
    experience,
    projects,
    education,
    certificates,
    languages,
    raw: text,
    meta: { accent: "#6366F1", includePhoto: false }
  };
}

function saveCvDataToLocalStorage(cvData){
  localStorage.setItem("resumeai_cvdata", JSON.stringify(cvData));
}

function goToCvPreview(mode){
  const qs = new URLSearchParams(location.search);
  const lang = (qs.get("lang") || "en").toLowerCase();
  window.location.href = `/cv.html?lang=${encodeURIComponent(lang)}#mode=${mode}`;
}

document.getElementById("downloadAts")?.addEventListener("click", ()=>{
  if (window.__isPreview) return alert("Preview mode: CV PDF is locked. Unlock to download.");

  const optimized = getOptimizedTextClean();
  if (!optimized) return alert("Optimized CV is empty.");

  const cvData = buildCvDataFromOptimizedText(optimized);
  saveCvDataToLocalStorage(cvData);
  goToCvPreview("ats");
});

document.getElementById("downloadModern")?.addEventListener("click", ()=>{
  if (window.__isPreview) return alert("Preview mode: CV PDF is locked. Unlock to download.");

  const optimized = getOptimizedTextClean();
  if (!optimized) return alert("Optimized CV is empty.");

  const cvData = buildCvDataFromOptimizedText(optimized);
  saveCvDataToLocalStorage(cvData);
  goToCvPreview("design");
});
  document.getElementById("y") && (document.getElementById("y").textContent = new Date().getFullYear());
</script>
  <footer style="margin-top:40px;padding:22px 0;border-top:1px solid rgba(255,255,255,.08);color:#94a3b8;font-size:13px;">
  <div style="max-width:980px;margin:auto;padding:0 20px;display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between;">
    <div>¬© <span id="y"></span> ResumeAI</div>
    <div style="display:flex;gap:14px;flex-wrap:wrap;">
      <a href="/terms.html">Terms</a>
      <a href="/privacy.html">Privacy</a>
      <a href="/refund.html">Refunds</a>
      <a href="mailto:support@resumeai.work">Support</a>
    </div>
  </div>
</footer>
</body>
</html>
