<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ResumeAI ‚Äì Analyze</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:Inter,system-ui,Arial;background:#0b0f19;color:#fff;}
    .wrap{max-width:980px;margin:auto;padding:60px 20px;}
    .top{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px;}
    .brand{font-weight:700;font-size:18px;letter-spacing:-0.3px;}
    .brand span{color:#6366F1;}
    a{color:#a0a6b8;text-decoration:none;}
    h1{margin:10px 0 10px 0;font-size:34px;}
    p{color:#a0a6b8;line-height:1.6;margin:0 0 28px 0;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
    textarea{
      width:100%;min-height:260px;resize:vertical;
      background:#111827;border:1px solid rgba(255,255,255,0.08);
      color:#fff;border-radius:14px;padding:14px;font-size:14px;line-height:1.5;
      outline:none;
    }
    textarea:focus{border-color:rgba(99,102,241,0.55);}
    .actions{display:flex;gap:12px;align-items:center;margin-top:16px;}
    button{
      padding:14px 18px;border:0;border-radius:12px;
      background:linear-gradient(135deg,#7b5cff,#5b3dff);
      color:#fff;font-weight:700;font-size:15px;cursor:pointer;
    }
    button:disabled{opacity:0.6;cursor:not-allowed;}
    .hint{color:#6b7280;font-size:13px;}
    .out{margin-top:30px;background:#0f1524;border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:18px;}
    .row{display:flex;gap:16px;flex-wrap:wrap;}
    .pill{background:rgba(99,102,241,0.10);border:1px solid rgba(99,102,241,0.22);padding:8px 12px;border-radius:999px;color:#e5e7eb;font-weight:600;}
    .sec{margin-top:16px;}
    .sec h3{margin:0 0 10px 0;font-size:16px;}
    ul{margin:0;padding-left:18px;color:#d1d5db;line-height:1.7;}
    pre{
      white-space:pre-wrap;word-wrap:break-word;
      background:#0b0f19;border:1px solid rgba(255,255,255,0.06);
      padding:14px;border-radius:14px;color:#e5e7eb;line-height:1.6;
    }
    @media(max-width:900px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">Resume<span>AI</span></div>
      <a href="/index.html">‚Üê Back</a>
    </div>
    <div id="langBar" style="position:sticky; top:0; z-index:999; margin:12px 0; padding:10px; display:flex; gap:10px; flex-wrap:wrap; background:rgba(17,24,39,.92); border:1px solid rgba(255,255,255,.12); border-radius:14px; backdrop-filter: blur(8px);"></div>

    <h1>ATS Analysis</h1>
    <p>Paste your resume and the job description. We‚Äôll return a structured analysis + optimized version.</p>
<div id="previewBanner" style="display:none; margin:14px 0; padding:12px 14px; border:1px dashed rgba(255,255,255,.25); border-radius:14px; background:rgba(255,255,255,.04);">
  <div style="font-weight:800; font-size:14px;">üîí Free Preview Mode ‚Äî only 20% shown</div>
  <div style="opacity:.85; font-size:13px; margin-top:6px;">
    Full report is locked: all missing keywords, all rewrites, and the complete optimized resume.
  </div>
  <a href="/analyze.html" style="display:inline-block; margin-top:10px; padding:10px 12px; border-radius:12px; background:#7c3aed; color:white; font-weight:800; text-decoration:none;">
    Unlock Lifetime Access
  </a>
</div>
    <div class="grid">
      <div>
        <div class="hint" style="margin-bottom:8px;">Resume (paste text)</div>
        <textarea id="resume" placeholder="Paste your resume here..."></textarea>
      </div>
      <div>
        <div class="hint" style="margin-bottom:8px;">Job description (paste text)</div>
        <textarea id="job" placeholder="Paste the job description here..."></textarea>
      </div>
    </div>

    <div class="actions">
      <button id="btn" onclick="run()">Analyze</button>
      <div class="hint" id="status"></div>
    </div>

    <div class="out" id="out" style="display:none;">
      <div class="row">
        <div class="pill" id="scorePill">ATS Match Score: ‚Äî</div>
      </div>
      <div class="actions" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
  <button class="btn" type="button" id="copyMissing">Copy Keywords</button>
  <button class="btn" type="button" id="copyWeak">Copy Weak</button>
  <button class="btn" type="button" id="copyOptimized">Copy Optimized</button>
  <button class="btn btn-ghost" type="button" id="downloadAts">Download ATS PDF</button>
<button class="btn btn-ghost" type="button" id="downloadModern">Download Modern PDF</button>
</div>

      <div class="sec">
        <h3>Missing Keywords</h3>
        <div id="kwPreviewNote" style="display:none; opacity:.8; font-size:13px; margin:6px 0 10px 0;">
   Preview shows only the first 5 keywords. Unlock to see the full list.
</div>
        <ul id="missing"></ul>
      </div>

      <div class="sec">
        <h3>Weak / Vague Phrases <span id="lockWeak" style="display:none;">üîí</span></h3>
        <ul id="weak"></ul>
      </div>

      <div class="sec">
        <h3>Optimized Resume (ATS + Recruiter-ready) <span id="lockOpt" style="display:none;">üîí</span></h3>
        <pre id="optimized"></pre>
      </div>
    </div>
  </div>

<script>
async function run(){
  const resume = document.getElementById('resume').value.trim();
  const job = document.getElementById('job').value.trim();
  const btn = document.getElementById('btn');
  const status = document.getElementById('status');

  if(!resume || !job){
    status.textContent = "Please paste both resume and job description.";
    return;
  }

  btn.disabled = true;
  status.textContent = "Analyzing‚Ä¶";
  document.getElementById('out').style.display = "none";

  try {
  const r = await fetch("/api/analyze", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    cv: resume,
    jd: job,
    preview: new URLSearchParams(location.search).get("preview") === "1",
    lang: new URLSearchParams(location.search).get("lang") || "en"
  })
});

  const rawText = await r.text();
let data = {};
try { data = JSON.parse(rawText); } catch {}

if (!r.ok) {
  const isPreview = new URLSearchParams(location.search).get("preview") === "1";

  // Preview modda API hata verirse, ekrana JSON basma ‚Üí sakin mesaj g√∂ster
  if (isPreview) {
    document.getElementById("status").textContent =
      "Preview is temporarily busy. Please try again in 10 seconds.";
    document.getElementById("btn").disabled = false;
    return; // burada √ßƒ±k
  }

  // Full modda eski davranƒ±≈ü aynen kalsƒ±n
  const msg =
    data?.details ||
    data?.model_output ||
    data?.error ||
    rawText ||
    "Request failed";
  throw new Error(msg);
}

// BURAYA KOY
const isPreview = new URLSearchParams(location.search).get("preview") === "1";
if (isPreview) {
  const b = document.getElementById("previewBanner");
  if (b) b.style.display = "block";

  const kwNote = document.getElementById("kwPreviewNote");
  if (kwNote) kwNote.style.display = "block";

  // üîí lock spanlarƒ±nƒ± burada a√ßƒ±yoruz
  const lw = document.getElementById("lockWeak");
  if (lw) lw.style.display = "inline";
  const lo = document.getElementById("lockOpt");
  if (lo) lo.style.display = "inline";
}
    document.getElementById('scorePill').textContent = `ATS Match Score: ${data.ats_score}%`;

    const missing = document.getElementById('missing');
    missing.innerHTML = "";
    (data.missing_keywords || []).forEach(k=>{
      const li = document.createElement('li');
      li.textContent = k;
      missing.appendChild(li);
    });

    const weak = document.getElementById('weak');
weak.innerHTML = "";

if (isPreview) {
  weak.innerHTML = "<li>üîí Preview: Weak phrases are locked. Unlock to see full rewrites.</li>";
} else {
  ((data.weak_phrases || data.weak_sentences || data.weak_vague_phrases || data.weaks || [])).forEach(k=>{
    const li = document.createElement('li');
    li.textContent = (typeof k === "string") ? k : ((k.sentence && k.rewrite) ? `${k.sentence} ‚Üí ${k.rewrite}` : JSON.stringify(k));
    weak.appendChild(li);
  });
}
      

   document.getElementById('optimized').textContent = isPreview
  ? "üîí Preview: Optimized resume is locked. Unlock to generate the full ATS-optimized version."
  : (data.optimized_resume || data.optimized_cv || data.optimizedResume || data.optimized || "");
    document.getElementById('out').style.display = "block";
    status.textContent = "Done.";
  }catch(e){
    status.textContent = "Error: " + (e.message || e);
  }finally{
    btn.disabled = false;
  }
}
  function copyText(text){
  if (!text) return alert("Nothing to copy.");
  navigator.clipboard.writeText(text)
    .then(()=> alert("Copied ‚úÖ"))
    .catch(()=> alert("Copy failed (iOS sometimes blocks)."));
}

document.getElementById("copyMissing")?.addEventListener("click", ()=>{
  const items = [...document.querySelectorAll("#missing li")].map(li=>li.textContent.trim()).filter(Boolean);
  copyText(items.map(x=>"- " + x).join("\n"));
});

document.getElementById("copyWeak")?.addEventListener("click", ()=>{
  const items = [...document.querySelectorAll("#weak li")].map(li=>li.textContent.trim()).filter(Boolean);
  copyText(items.map(x=>"- " + x).join("\n"));
});

document.getElementById("copyOptimized")?.addEventListener("click", ()=>{
  const text = (document.getElementById("optimized")?.textContent || "").trim();
  copyText(text);
});

function buildCvDataFromOptimizedText(optimizedText){
  let t = (optimizedText || "").trim();

  // En sonda kalan META √ß√∂plerini bir kez daha temizle (garanti)
  t = t.replace(/\n?\s*META\s*:[\s\S]*$/i, "").replace(/\n?\s*META\s*\{[\s\S]*$/i, "").trim();

  const lines = t.split("\n").map(x => x.trim()).filter(Boolean);

  // Helpers
  const getEmail = (s) => (s.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i) || [])[0] || "";
  const getPhone = (s) => (s.match(/(\+?\d[\d\s().-]{8,}\d)/) || [])[0] || "";
  const getUrls  = (s) => [...s.matchAll(/https?:\/\/[^\s)]+/g)].map(m=>m[0]);

  const isHeader = (x) => {
    const k = x.toUpperCase().replace(/[:]/g,"").trim();
    const headers = [
      "SUMMARY","PROFESSIONAL SUMMARY","PROFILE","√ñZET","PROFESYONEL √ñZET",
      "SKILLS","CORE SKILLS","YETKƒ∞NLƒ∞KLER","BECERƒ∞LER",
      "EXPERIENCE","WORK EXPERIENCE","EMPLOYMENT","DENEYƒ∞M","ƒ∞≈û DENEYƒ∞Mƒ∞",
      "EDUCATION","Eƒûƒ∞Tƒ∞M",
      "PROJECTS","PROJELER",
      "CERTIFICATES","CERTIFICATIONS","SERTƒ∞Fƒ∞KALAR",
      "LANGUAGES","Dƒ∞LLER",
      "CONTACT","ƒ∞LETƒ∞≈ûƒ∞M"
    ];
    return headers.includes(k);
  };

  const normHeaderKey = (x) => x.toUpperCase().replace(/[:]/g,"").trim();

  // 1) Name + Title (ilk 2 satƒ±rdan)
  const fullName = lines[0] && lines[0].length <= 60 ? lines[0] : "Your Name";

  let title = "‚Äî";
  for (let i=1; i<Math.min(lines.length,6); i++){
    const s = lines[i];
    if (!s) continue;
    if (isHeader(s)) break;
    if (s.includes("@") || s.includes("http")) continue;
    if (s.length <= 60) { title = s; break; }
  }

  // 2) Contact (email/phone/links t√ºm metinden)
  const email = getEmail(t);
  const phone = getPhone(t);
  const urls  = getUrls(t);

  const links = [];
  urls.slice(0,6).forEach(u=>{
    const low = u.toLowerCase();
    if (low.includes("linkedin")) links.push({label:"LinkedIn", url:u});
    else if (low.includes("github")) links.push({label:"GitHub", url:u});
    else if (low.includes("portfolio")) links.push({label:"Portfolio", url:u});
    else links.push({label:"Link", url:u});
  });

  // 3) Section parse
  const sections = {
    SUMMARY: [],
    SKILLS: [],
    EXPERIENCE: [],
    EDUCATION: [],
    PROJECTS: [],
    CERTIFICATES: [],
    LANGUAGES: []
  };

  let cur = null;
  for (const raw of lines){
    if (isHeader(raw)){
      const hk = normHeaderKey(raw);
      if (hk.includes("SUMMARY") || hk.includes("√ñZET") || hk.includes("PROFILE")) cur = "SUMMARY";
      else if (hk.includes("SKILLS") || hk.includes("YETKƒ∞NLƒ∞K") || hk.includes("BECERƒ∞")) cur = "SKILLS";
      else if (hk.includes("EXPERIENCE") || hk.includes("DENEYƒ∞M") || hk.includes("EMPLOY")) cur = "EXPERIENCE";
      else if (hk.includes("EDUCATION") || hk.includes("Eƒûƒ∞Tƒ∞M")) cur = "EDUCATION";
      else if (hk.includes("PROJECTS") || hk.includes("PROJEL")) cur = "PROJECTS";
      else if (hk.includes("CERT") || hk.includes("SERTƒ∞F")) cur = "CERTIFICATES";
      else if (hk.includes("LANG") || hk.includes("Dƒ∞LL")) cur = "LANGUAGES";
      else cur = null;
      continue;
    }
    if (!cur) continue;
    sections[cur].push(raw);
  }

  // 4) Summary
  const summary = sections.SUMMARY.join(" ").trim();

  // 5) Skills: satƒ±r satƒ±r veya virg√ºlle
  const skills = [];
  const skillText = sections.SKILLS.join(" ");
  if (skillText){
    const parts = skillText.split(/‚Ä¢|,|;|\||\t/).map(x=>x.trim()).filter(Boolean);
    const uniq = new Set();
    for (const p of parts){
      const name = p.replace(/^[-‚Ä¢]\s*/,"").trim();
      if (!name || name.length > 40) continue;
      const key = name.toLowerCase();
      if (uniq.has(key)) continue;
      uniq.add(key);
      skills.push({name, level:""});
      if (skills.length >= 28) break;
    }
  }

  // 6) Experience: ‚ÄúRole‚Äù, ‚ÄúCompany | Date‚Äù + bullets ≈üeklini yakala
  const experience = [];
  const expLines = sections.EXPERIENCE;

  function parseDateRange(s){
    // "2020 ‚Äì Present" / "2020 - 2022"
    const m = s.match(/(\d{4}|\d{4}-\d{2})\s*[‚Äì-]\s*(Present|G√ºn√ºm√ºz|\d{4}|\d{4}-\d{2})/i);
    if (!m) return {start:"", end:null};
    const start = m[1];
    const endRaw = m[2];
    const end = /present|g√ºn√ºm√ºz/i.test(endRaw) ? null : endRaw;
    return {start, end};
  }

  let i = 0;
  while (i < expLines.length){
    const line1 = expLines[i] || "";
    const line2 = expLines[i+1] || "";

    // Role satƒ±rƒ± gibi
    const role = line1 && line1.length <= 80 ? line1 : "";
    let company = "";
    let start = "";
    let end = null;

    // Company | date satƒ±rƒ± gibi
    if (line2.includes("|") || parseDateRange(line2).start){
      const parts = line2.split("|").map(x=>x.trim());
      company = parts[0] || "";
      const dr = parseDateRange(line2);
      start = dr.start;
      end = dr.end;
      i += 2;
    } else {
      // Alternatif: "Role ‚Äî Company | dates" tek satƒ±r
      const tryOne = line1;
      const p = tryOne.split("|").map(x=>x.trim());
      if (p.length >= 2){
        const left = p[0];
        const dr = parseDateRange(tryOne);
        const lc = left.split("‚Äî").map(x=>x.trim());
        if (lc.length >= 2){
          // "Role ‚Äî Company"
          company = lc.slice(1).join(" ‚Äî ");
          start = dr.start;
          end = dr.end;
        }
      }
      i += 1;
    }

    // bullet/highlights topla
    const highlights = [];
    while (i < expLines.length){
      const l = expLines[i];
      if (!l) { i++; continue; }
      if (isHeader(l)) break;
      // yeni role ba≈ülamasƒ± ihtimali (bo≈üluk yok ama b√ºy√ºk yazƒ± vs) i√ßin kaba durdurma:
      if (!l.startsWith("-") && !l.startsWith("‚Ä¢") && highlights.length >= 4 && l.length <= 70) break;

      if (l.startsWith("-") || l.startsWith("‚Ä¢")){
        highlights.push(l.replace(/^[-‚Ä¢]\s*/,"").trim());
      } else {
        // bullet olmayan satƒ±rlarƒ± da highlight‚Äôa al (ATS i√ßin)
        highlights.push(l.trim());
      }
      i++;
      if (highlights.length >= 8) break;
    }

    if (role || company || highlights.length){
      experience.push({
        company: company || "",
        position: role || "Role",
        start,
        end,
        location: "",
        highlights: highlights.length ? highlights : []
      });
    }
  }

  // 7) Education (basit)
  const education = [];
  if (sections.EDUCATION.length){
    const school = sections.EDUCATION.find(x=>x.length <= 90) || "";
    const degree = sections.EDUCATION[1] || "";
    education.push({school, degree, start:"", end:""});
  }

  // 8) Projects (basit)
  const projects = [];
  if (sections.PROJECTS.length){
    const name = sections.PROJECTS[0] || "Project";
    const highlights = sections.PROJECTS.slice(1,6).map(x=>x.replace(/^[-‚Ä¢]\s*/,"").trim());
    projects.push({name, tech: [], highlights});
  }

  // 9) Certificates / Languages
  const certificates = (sections.CERTIFICATES || []).slice(0,10).map(x=>x.replace(/^[-‚Ä¢]\s*/,"").trim());
  const languages = (sections.LANGUAGES || []).slice(0,10).map(x=>({name:x.replace(/^[-‚Ä¢]\s*/,"").trim(), level:""}));

  return {
    basics: {
      fullName,
      title,
      location: "",              // istersen sonra parse ederiz
      phone,
      email,
      links,
      photoUrl: ""
    },
    summary,
    skills,
    experience,
    projects,
    education,
    certificates,
    languages,
    meta: { accent: "#6366F1", includePhoto: false }
  };
  }

function saveCvDataToLocalStorage(cvData){
  localStorage.setItem("resumeai_cvdata", JSON.stringify(cvData));
}

function goToCvPreview(mode){
  // mode: "ats" veya "design"
  window.location.href = `/cv.html#mode=${mode}`;
}

document.getElementById("downloadAts")?.addEventListener("click", ()=>{
  const isPreview = new URLSearchParams(location.search).get("preview") === "1";
  if (isPreview) return alert("Preview mode: CV PDF is locked. Unlock to download.");

  let optimized = (document.getElementById("optimized")?.textContent || "");

// META: {...} gibi sonda gelen √ß√∂pleri temizle
optimized = optimized.replace(/\n?\s*META\s*:[\s\S]*$/i, "");
optimized = optimized.replace(/\n?\s*META\s*\{[\s\S]*$/i, "");

// toparla
optimized = optimized.trim();
  if (!optimized) return alert("Optimized CV is empty.");

  const cvData = buildCvDataFromOptimizedText(optimized);
  saveCvDataToLocalStorage(cvData);
  goToCvPreview("ats");
});

document.getElementById("downloadModern")?.addEventListener("click", ()=>{
  const isPreview = new URLSearchParams(location.search).get("preview") === "1";
  if (isPreview) return alert("Preview mode: CV PDF is locked. Unlock to download.");

  let optimized = (document.getElementById("optimized")?.textContent || "");

// META: {...} gibi sonda gelen √ß√∂pleri temizle
optimized = optimized.replace(/\n?\s*META\s*:[\s\S]*$/i, "");

// Bazƒ± modeller "META { ... }" gibi yazabiliyor ‚Üí onu da temizle
optimized = optimized.replace(/\n?\s*META\s*\{[\s\S]*$/i, "");

// Fazla bo≈üluklarƒ± toparla
optimized = optimized.trim();
  if (!optimized) return alert("Optimized CV is empty.");

  const cvData = buildCvDataFromOptimizedText(optimized);
  saveCvDataToLocalStorage(cvData);
  goToCvPreview("design");
});

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
  (function(){
  const bar = document.getElementById("langBar");
  if (!bar) return;

  const qs = new URLSearchParams(window.location.search);
  const current = qs.get("lang") || "en";
  const preview = qs.get("preview"); // varsa "1"

  const langs = [
  ["en","EN"],
  ["tr","TR"],
  ["es","ES"],
  ["ru","RU"],
  ["fr","FR"],
  ["ar","AR"],
  ["zh","‰∏≠Êñá"]
];

  function buildHref(langCode){
    const p = new URLSearchParams();
    if (preview) p.set("preview", preview);  // preview=1 aynen korunur
    p.set("lang", langCode);
    return window.location.pathname + "?" + p.toString();
  }

  bar.innerHTML = "";
  langs.forEach(([code,label])=>{
    const a = document.createElement("a");
    a.className = "btn btn-ghost";
  
  a.style.cssText = (code === current)
  ? "opacity:1;font-weight:900;padding:10px 12px;font-size:14px;border-radius:12px;background:rgba(109,94,252,.95);color:#fff;border:1px solid rgba(255,255,255,.18);"
  : "opacity:.85;padding:10px 12px;font-size:14px;border-radius:12px;background:transparent;color:#cbd5e1;border:1px solid rgba(255,255,255,.22);";
    a.setAttribute("href", buildHref(code));
    a.textContent = label;
    bar.appendChild(a);
  });
})();
</script>
</body>
</html>
