<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ResumeAI ‚Äì Analyze</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:Inter,system-ui,Arial;background:#0b0f19;color:#fff;}
    .wrap{max-width:980px;margin:auto;padding:60px 20px;}
    .top{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px;}
    .brand{font-weight:700;font-size:18px;letter-spacing:-0.3px;}
    .brand span{color:#6366F1;}
    a{color:#a0a6b8;text-decoration:none;}
    h1{margin:10px 0 10px 0;font-size:34px;}
    p{color:#a0a6b8;line-height:1.6;margin:0 0 28px 0;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
    textarea{
      width:100%;min-height:260px;resize:vertical;
      background:#111827;border:1px solid rgba(255,255,255,0.08);
      color:#fff;border-radius:14px;padding:14px;font-size:14px;line-height:1.5;
      outline:none;
    }
    textarea:focus{border-color:rgba(99,102,241,0.55);}
    .actions{display:flex;gap:12px;align-items:center;margin-top:16px;}
    button{
      padding:14px 18px;border:0;border-radius:12px;
      background:linear-gradient(135deg,#7b5cff,#5b3dff);
      color:#fff;font-weight:700;font-size:15px;cursor:pointer;
    }
    button:disabled{opacity:0.6;cursor:not-allowed;}
    .hint{color:#6b7280;font-size:13px;}
    .out{margin-top:30px;background:#0f1524;border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:18px;}
    .row{display:flex;gap:16px;flex-wrap:wrap;}
    .pill{background:rgba(99,102,241,0.10);border:1px solid rgba(99,102,241,0.22);padding:8px 12px;border-radius:999px;color:#e5e7eb;font-weight:600;}
    .sec{margin-top:16px;}
    .sec h3{margin:0 0 10px 0;font-size:16px;}
    ul{margin:0;padding-left:18px;color:#d1d5db;line-height:1.7;}
    pre{
      white-space:pre-wrap;word-wrap:break-word;
      background:#0b0f19;border:1px solid rgba(255,255,255,0.06);
      padding:14px;border-radius:14px;color:#e5e7eb;line-height:1.6;
    }
    @media(max-width:900px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">Resume<span>AI</span></div>
      <a href="/index.html">‚Üê Back</a>
    </div>
    <div id="langBar" style="position:sticky; top:0; z-index:999; margin:12px 0; padding:10px; display:flex; gap:10px; flex-wrap:wrap; background:rgba(17,24,39,.92); border:1px solid rgba(255,255,255,.12); border-radius:14px; backdrop-filter: blur(8px);"></div>

    <h1>ATS Analysis</h1>
    <p>Paste your resume and the job description. We‚Äôll return a structured analysis + optimized version.</p>
<div id="previewBanner" style="display:none; margin:14px 0; padding:12px 14px; border:1px dashed rgba(255,255,255,.25); border-radius:14px; background:rgba(255,255,255,.04);">
  <div style="font-weight:800; font-size:14px;">üîí Free Preview Mode ‚Äî only 20% shown</div>
  <div style="opacity:.85; font-size:13px; margin-top:6px;">
    Full report is locked: all missing keywords, all rewrites, and the complete optimized resume.
  </div>
  <a href="/analyze.html" style="display:inline-block; margin-top:10px; padding:10px 12px; border-radius:12px; background:#7c3aed; color:white; font-weight:800; text-decoration:none;">
    Unlock Lifetime Access
  </a>
</div>
    <div class="grid">
      <div>
        <div class="hint" style="margin-bottom:8px;">Resume (paste text)</div>
        <textarea id="resume" placeholder="Paste your resume here..."></textarea>
      </div>
      <div>
        <div class="hint" style="margin-bottom:8px;">Job description (paste text)</div>
        <textarea id="job" placeholder="Paste the job description here..."></textarea>
      </div>
    </div>

    <div class="actions">
      <button id="btn" onclick="run()">Analyze</button>
      <div class="hint" id="status"></div>
    </div>

    <div class="out" id="out" style="display:none;">
      <div class="row">
        <div class="pill" id="scorePill">ATS Match Score: ‚Äî</div>
      </div>
      <div class="actions" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
  <button class="btn" type="button" id="copyMissing">Copy Keywords</button>
  <button class="btn" type="button" id="copyWeak">Copy Weak</button>
  <button class="btn" type="button" id="copyOptimized">Copy Optimized</button>
  <button class="btn btn-ghost" type="button" id="downloadAts">Download ATS PDF</button>
<button class="btn btn-ghost" type="button" id="downloadModern">Download Modern PDF</button>
</div>

      <div class="sec">
        <h3>Missing Keywords</h3>
        <div id="kwPreviewNote" style="display:none; opacity:.8; font-size:13px; margin:6px 0 10px 0;">
   Preview shows only the first 5 keywords. Unlock to see the full list.
</div>
        <ul id="missing"></ul>
      </div>

      <div class="sec">
        <h3>Weak / Vague Phrases <span id="lockWeak" style="display:none;">üîí</span></h3>
        <ul id="weak"></ul>
      </div>

      <div class="sec">
        <h3>Optimized Resume (ATS + Recruiter-ready) <span id="lockOpt" style="display:none;">üîí</span></h3>
        <pre id="optimized"></pre>
      </div>
    </div>
  </div>

<script>
async function run(){
  const resume = document.getElementById('resume').value.trim();
  const job = document.getElementById('job').value.trim();
  const btn = document.getElementById('btn');
  const status = document.getElementById('status');

  if(!resume || !job){
    status.textContent = "Please paste both resume and job description.";
    return;
  }

  btn.disabled = true;
  status.textContent = "Analyzing‚Ä¶";
  document.getElementById('out').style.display = "none";

  try {
  const r = await fetch("/api/analyze", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    cv: resume,
    jd: job,
    preview: new URLSearchParams(location.search).get("preview") === "1",
    lang: new URLSearchParams(location.search).get("lang") || "en"
  })
});

  const rawText = await r.text();
let data = {};
try { data = JSON.parse(rawText); } catch {}

if (!r.ok) {
  const msg =
    data?.details ||
    data?.model_output ||
    data?.error ||
    rawText ||
    "Request failed";
  throw new Error(msg);
}

// BURAYA KOY
const isPreview = new URLSearchParams(location.search).get("preview") === "1";
if (isPreview) {
  const b = document.getElementById("previewBanner");
  if (b) b.style.display = "block";

  const kwNote = document.getElementById("kwPreviewNote");
  if (kwNote) kwNote.style.display = "block";

  // üîí lock spanlarƒ±nƒ± burada a√ßƒ±yoruz
  const lw = document.getElementById("lockWeak");
  if (lw) lw.style.display = "inline";
  const lo = document.getElementById("lockOpt");
  if (lo) lo.style.display = "inline";
}
    document.getElementById('scorePill').textContent = `ATS Match Score: ${data.ats_score}%`;

    const missing = document.getElementById('missing');
    missing.innerHTML = "";
    (data.missing_keywords || []).forEach(k=>{
      const li = document.createElement('li');
      li.textContent = k;
      missing.appendChild(li);
    });

    const weak = document.getElementById('weak');
weak.innerHTML = "";

if (isPreview) {
  weak.innerHTML = "<li>üîí Preview: Weak phrases are locked. Unlock to see full rewrites.</li>";
} else {
  ((data.weak_phrases || data.weak_sentences || data.weak_vague_phrases || data.weaks || [])).forEach(k=>{
    const li = document.createElement('li');
    li.textContent = (typeof k === "string") ? k : ((k.sentence && k.rewrite) ? `${k.sentence} ‚Üí ${k.rewrite}` : JSON.stringify(k));
    weak.appendChild(li);
  });
}
      

   document.getElementById('optimized').textContent = isPreview
  ? "üîí Preview: Optimized resume is locked. Unlock to generate the full ATS-optimized version."
  : (data.optimized_resume || data.optimized_cv || data.optimizedResume || data.optimized || "");
    document.getElementById('out').style.display = "block";
    status.textContent = "Done.";
  }catch(e){
    status.textContent = "Error: " + (e.message || e);
  }finally{
    btn.disabled = false;
  }
}
  function copyText(text){
  if (!text) return alert("Nothing to copy.");
  navigator.clipboard.writeText(text)
    .then(()=> alert("Copied ‚úÖ"))
    .catch(()=> alert("Copy failed (iOS sometimes blocks)."));
}

document.getElementById("copyMissing")?.addEventListener("click", ()=>{
  const items = [...document.querySelectorAll("#missing li")].map(li=>li.textContent.trim()).filter(Boolean);
  copyText(items.map(x=>"- " + x).join("\n"));
});

document.getElementById("copyWeak")?.addEventListener("click", ()=>{
  const items = [...document.querySelectorAll("#weak li")].map(li=>li.textContent.trim()).filter(Boolean);
  copyText(items.map(x=>"- " + x).join("\n"));
});

document.getElementById("copyOptimized")?.addEventListener("click", ()=>{
  const text = (document.getElementById("optimized")?.textContent || "").trim();
  copyText(text);
});

function buildCvDataFromOptimizedText(optimizedText){
  // Basit: Tek metni √∂zet alanƒ±na koyuyoruz.
  // Sonra istersen parser ile deneyim/skill ayƒ±rƒ±rƒ±z.
  const firstLine = optimizedText.split("\n")[0]?.trim();
  const fullName = (firstLine && firstLine.length <= 40) ? firstLine : "Your Name";

  return {
    basics: {
      fullName,
      title: "‚Äî",
      location: "",
      phone: "",
      email: "",
      links: [],
      photoUrl: ""
    },
    summary: optimizedText.slice(0, 500), // ilk 500 karakter √∂zet gibi
    skills: [],
    experience: [],
    projects: [],
    education: [],
    certificates: [],
    languages: [],
    meta: { accent: "#2B6CB0", includePhoto: false }
  };
}

function saveCvDataToLocalStorage(cvData){
  localStorage.setItem("resumeai_cvdata", JSON.stringify(cvData));
}

function goToCvPreview(mode){
  // mode: "ats" veya "design"
  window.location.href = `/cv.html#mode=${mode}`;
}

document.getElementById("downloadAts")?.addEventListener("click", ()=>{
  const isPreview = new URLSearchParams(location.search).get("preview") === "1";
  if (isPreview) return alert("Preview mode: CV PDF is locked. Unlock to download.");

  const optimized = (document.getElementById("optimized")?.textContent || "").trim();
  if (!optimized) return alert("Optimized CV is empty.");

  const cvData = buildCvDataFromOptimizedText(optimized);
  saveCvDataToLocalStorage(cvData);
  goToCvPreview("ats");
});

document.getElementById("downloadModern")?.addEventListener("click", ()=>{
  const isPreview = new URLSearchParams(location.search).get("preview") === "1";
  if (isPreview) return alert("Preview mode: CV PDF is locked. Unlock to download.");

  let optimized = (document.getElementById("optimized")?.textContent || "");

// META: {...} gibi sonda gelen √ß√∂pleri temizle
optimized = optimized.replace(/\n?\s*META\s*:[\s\S]*$/i, "");

// Bazƒ± modeller "META { ... }" gibi yazabiliyor ‚Üí onu da temizle
optimized = optimized.replace(/\n?\s*META\s*\{[\s\S]*$/i, "");

// Fazla bo≈üluklarƒ± toparla
optimized = optimized.trim();
  if (!optimized) return alert("Optimized CV is empty.");

  const cvData = buildCvDataFromOptimizedText(optimized);
  saveCvDataToLocalStorage(cvData);
  goToCvPreview("design");
});

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
  (function(){
  const bar = document.getElementById("langBar");
  if (!bar) return;

  const qs = new URLSearchParams(window.location.search);
  const current = qs.get("lang") || "en";
  const preview = qs.get("preview"); // varsa "1"

  const langs = [
  ["en","EN"],
  ["tr","TR"],
  ["es","ES"],
  ["ru","RU"],
  ["fr","FR"],
  ["ar","AR"],
  ["zh","‰∏≠Êñá"]
];

  function buildHref(langCode){
    const p = new URLSearchParams();
    if (preview) p.set("preview", preview);  // preview=1 aynen korunur
    p.set("lang", langCode);
    return window.location.pathname + "?" + p.toString();
  }

  bar.innerHTML = "";
  langs.forEach(([code,label])=>{
    const a = document.createElement("a");
    a.className = "btn btn-ghost";
  
  a.style.cssText = (code === current)
  ? "opacity:1;font-weight:900;padding:10px 12px;font-size:14px;border-radius:12px;background:rgba(109,94,252,.95);color:#fff;border:1px solid rgba(255,255,255,.18);"
  : "opacity:.85;padding:10px 12px;font-size:14px;border-radius:12px;background:transparent;color:#cbd5e1;border:1px solid rgba(255,255,255,.22);";
    a.setAttribute("href", buildHref(code));
    a.textContent = label;
    bar.appendChild(a);
  });
})();
</script>
</body>
</html>
